<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no">
    <title>Fappy Bird Game</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body>

    <div id="playerCards">

    </div>

    <div id="beforeGame">
        <div class="row">
            <p>Enter your name:</p>
            <input type="text" id="name-input" placeholder="Your name">
        </div>
        <div class="row">
            <p>Select your color</p>
            <input type="color" id="colorPicker" name="colorPicker">
        </div>
        <button id="save-options">Save</button>
        <button id="readyButton">Ready</button>


    </div>



    <div>
        <table>
            <thead>
                <tr>
                    <th>Player</th>
                    <th>State</th>
                    <th>Score</th>
                </tr>
            </thead>
            <tbody id="players-table">
            </tbody>
        </table>
    </div>

    <div id="game-container">
        <canvas id="gameCanvas" width="400" height="600"></canvas>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/recolor-image/1.0.0/recolor-image.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.3.1/socket.io.js"></script>
    <script>


        const socket = io();
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        let usersBirds = []

        document.getElementById('readyButton').addEventListener('click', () => {
            socket.emit('toggleReady');
        });

        document.getElementById('save-options').addEventListener('click', () => {
            let name = document.getElementById('name-input').value
            let color = document.getElementById('colorPicker').value
            socket.emit('savePlayerInfo', { 'name': name, 'color': color });

        });

        socket.on('startGame', () => {
            document.getElementById('game-container').style.display = 'flex'
            document.getElementById("beforeGame").style.display = 'none'

        });



        socket.on('render', (data) => {
            const PIPE_WIDTH = data.pipe_width
            const PIPE_GAP = data.pipe_gap
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            data.users.forEach(user => {
                const userBird = usersBirds.find(u => u.userId === user.id)
                const image = new Image()
                image.src = userBird.bird;
                if (userBird.userId !== socket.id) {
                    ctx.globalAlpha = 0.4;
                }
                ctx.drawImage(image, user.bird.x, user.bird.y, user.bird.width, user.bird.height);
                ctx.globalAlpha = 1;
            });




            // Draw pipes
            ctx.fillStyle = 'green';
            for (let pipe of data.pipes) {
                ctx.fillRect(pipe.x, 0, PIPE_WIDTH, pipe.y);
                ctx.fillRect(pipe.x, pipe.y + PIPE_GAP, PIPE_WIDTH, canvas.height - (pipe.y + PIPE_GAP));
            }
        })

        socket.on('gameOver', (message) => {
            console.log(message);
        })

        socket.on('gameEnd', (message) => {
            console.log(message);
        })

        socket.on('updateBirds', (data) => {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            usersBirds = []
            data.forEach(userBird => {
                let bird = userBird.bird
                // Set canvas dimensions
                canvas.width = bird.width;
                canvas.height = bird.height;


                // Create ImageData object from received image data
                const imageDataObject = new ImageData(new Uint8ClampedArray(bird.data), bird.width, bird.height);

                // Put the received image data onto the canvas
                ctx.putImageData(imageDataObject, 0, 0);

                // Convert the canvas content to a data URL
                const dataURL = canvas.toDataURL('image/png');

                usersBirds.push({ 'userId': userBird.userId, 'bird': dataURL })

                //TODO-RISO najst img s id socketu a nastavit img
                let image = document.getElementById(userBird.userId)
                console.log(image)
            })
        })


        socket.on('updateUsers', (data) => {

            let cardsDiv = document.getElementById('playerCards')
            cardsDiv.innerHTML = ""

            let playersTable = document.getElementById("players-table")
            playersTable.innerHTML = ""

            //TODO-riso toto cele presunut do updateBirds s tym ze do birds potrebujem dostat info o name a status
            data.forEach(player => {

                const userBird = usersBirds.find(u => u.userId === player.id)
                const div = document.createElement('div')
                div.classList.add('playerCard')

                const birdImg = document.createElement('img')
                birdImg.classList.add('playerBird')
                birdImg.src = userBird.bird
                birdImg.setAttribute("id", player.id);

                const statusImg = document.createElement('img')
                statusImg.classList.add('playerStatus')
                if (!player.alive) {
                    statusImg.src = './dead.png'
                } else {
                    statusImg.src = `${player.ready ? './ready.png' : './not_ready.png'}`
                }

                const nameP = document.createElement('p')
                nameP.innerHTML = `${player.name}`

                div.appendChild(nameP)
                div.appendChild(birdImg)
                div.appendChild(statusImg)
                cardsDiv.appendChild(div)





                let row = document.createElement("tr")

                let name = document.createElement('td')
                let ready = document.createElement('td')
                let score = document.createElement('td')

                name.innerHTML = `${player.name}`
                ready.innerHTML = `${player.ready ? 'ready' : 'not ready'}`

                if (!player.alive) {
                    ready.innerHTML = 'dead'
                }

                score.innerHTML = `${player.score}`

                name.style.color = player.color
                row.appendChild(name)
                row.appendChild(ready)
                row.appendChild(score)


                playersTable.appendChild(row)
            });
        });

        // Handle user input (flap bird)
        document.addEventListener('keydown', handleInput);
        document.addEventListener('click', handleJump);
        document.addEventListener('touchstart', handleJump);
        function handleInput(event) {
            if (event.code === 'Space') {
                handleJump(event)
            }
        }

        function handleJump(event) {
            // Emit 'jump' event when the screen is tapped or clicked
            socket.emit('jump', socket.id);
        }
    </script>
</body>

</html>