<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no">
    <title>Fappy Bird Game</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body>

    <div id="beforeGame">
        <div class="row">
            <p>Enter your name:</p>
            <input type="text" id="name-input" placeholder="Your name">
        </div>
        <div class="row">
            <p>Select your color</p>
            <input type="color" id="colorPicker" name="colorPicker">
        </div>
        <button id="save-options">Save</button>
        <button id="readyButton">Ready</button>


    </div>

   

    <div>
        <table >
            <thead>
                <tr>
                    <th>Player</th>
                    <th>State</th>
                    <th>Score</th>
                </tr>
            </thead>
            <tbody id="players-table">
            </tbody>
        </table>
    </div>

    <div id="game-container">
        <canvas id="gameCanvas" width="400" height="600"></canvas>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.3.1/socket.io.js"></script>
    <script>

        function hexToRGBA(hex, alpha) {
            // Remove the '#' at the beginning if it's there
            hex = hex.replace('#', '');

            // Convert hexadecimal to decimal
            const r = parseInt(hex.substring(0, 2), 16);
            const g = parseInt(hex.substring(2, 4), 16);
            const b = parseInt(hex.substring(4, 6), 16);

            // Return RGBA value
            return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        }

        const socket = io();

        document.getElementById('readyButton').addEventListener('click', () => {
            socket.emit('toggleReady');
        });

        document.getElementById('save-options').addEventListener('click', () => {
            let name = document.getElementById('name-input').value
            let color = document.getElementById('colorPicker').value
            if (name === '' || name == null) {
                alert("name mumst not be empty")
            } else {
                socket.emit('savePlayerInfo', { 'name': name, 'color': color });
            }

        });

        socket.on('startGame', () => {
            document.getElementById('game-container').style.display = 'flex'
            document.getElementById("beforeGame").style.display = 'none'

        });

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        socket.on('render', (data) => {
            const PIPE_WIDTH = data.pipe_width
            const PIPE_GAP = data.pipe_gap
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            data.users.forEach(user => {

                if (user.id === socket.id) {
                    // Draw bird for own player
                    ctx.fillStyle = hexToRGBA(user.color, 1);
                }
                else {
                    // Draw bird for other players
                    ctx.fillStyle = hexToRGBA(user.color, 0.2);
                }
                ctx.fillRect(user.bird.x, user.bird.y, user.bird.width, user.bird.height);

            });


            // Draw pipes
            ctx.fillStyle = 'green';
            for (let pipe of data.pipes) {
                ctx.fillRect(pipe.x, 0, PIPE_WIDTH, pipe.y);
                ctx.fillRect(pipe.x, pipe.y + PIPE_GAP, PIPE_WIDTH, canvas.height - (pipe.y + PIPE_GAP));
            }
        })

        socket.on('gameOver', (message) => {
            console.log(message);
        })

        socket.on('gameEnd', (message) => {
            console.log(message);
        })

        socket.on('updateUsers', (data) => {
            let playersTable = document.getElementById("players-table")
            playersTable.innerHTML = ""

            data.forEach(player => {

                let row = document.createElement("tr")

                let name = document.createElement('td')
                let ready = document.createElement('td')
                let score = document.createElement('td')

                name.innerHTML = `${player.name}`
                ready.innerHTML = `${player.ready ? 'ready' : 'not ready'}`

                if (!player.alive) {
                    ready.innerHTML = 'dead'
                }

                score.innerHTML = `${player.score}`

                name.style.color = player.color
                row.appendChild(name)
                row.appendChild(ready)
                row.appendChild(score)


                playersTable.appendChild(row)
            });
        });

        // Handle user input (flap bird)
        document.addEventListener('keydown', handleInput);
        document.addEventListener('click', handleJump);
        document.addEventListener('touchstart', handleJump);
        function handleInput(event) {
            if (event.code === 'Space') {
                handleJump(event)
            }
        }

        function handleJump(event) {
            // Emit 'jump' event when the screen is tapped or clicked
            socket.emit('jump', socket.id);
        }
    </script>
</body>

</html>